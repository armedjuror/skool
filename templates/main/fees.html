{% extends 'main/layout.html' %}
{% load static %}

{% block page_title %}Fee Management{% endblock %}

{% block content %}
<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-white-50">This Month Collection</h6>
                        <h3 class="mb-0" id="monthCollection">QAR 0</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-money-bill-wave fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-white-50">Total Pending Dues</h6>
                        <h3 class="mb-0" id="totalDues">QAR 0</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-circle fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-dark-50">Students with Dues</h6>
                        <h3 class="mb-0" id="studentsWithDues">0</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-clock fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-white-50">Active Fee Types</h6>
                        <h3 class="mb-0" id="activeFeeTypes">0</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tags fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="feeTabs">
    <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#feeCollection">
            <i class="fas fa-cash-register"></i> Fee Collection
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#feeDues">
            <i class="fas fa-file-invoice-dollar"></i> Fee Dues
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#feeTypes">
            <i class="fas fa-tags"></i> Fee Types
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#feeStructure">
            <i class="fas fa-sitemap"></i> Fee Structure
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#collectionHistory">
            <i class="fas fa-history"></i> Collection History
        </a>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content">
    <!-- Fee Collection Tab -->
    <div class="tab-pane fade show active" id="feeCollection">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-search"></i> Find Student</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Search Student</label>
                            <input type="text" class="form-control" id="studentSearch"
                                   placeholder="Enter admission number or name...">
                        </div>
                        <div id="studentSearchResults" class="list-group" style="max-height: 300px; overflow-y: auto;">
                            <!-- Search results -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-money-bill"></i> Collect Fee</h5>
                    </div>
                    <div class="card-body" id="feeCollectionForm">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-user-graduate fa-3x mb-3"></i>
                            <p>Select a student to collect fees</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fee Dues Tab -->
    <div class="tab-pane fade" id="feeDues">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter"></i> Filter Dues</h5>
            </div>
            <div class="card-body">
                <form id="duesFilterForm">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Branch</label>
                            <select class="form-select" id="duesBranchFilter" name="branch">
                                <option value="">All Branches</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Class</label>
                            <select class="form-select" id="duesClassFilter" name="class">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Fee Type</label>
                            <select class="form-select" id="duesFeeTypeFilter" name="fee_type">
                                <option value="">All Types</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Filter
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="clearDuesFilters">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-body">
                <div id="duesTable">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading dues...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fee Types Tab -->
    <div class="tab-pane fade" id="feeTypes">
        <div class="card">
            <div class="card-body">
                <div id="feeTypesTable">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading fee types...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fee Structure Tab -->
    <div class="tab-pane fade" id="feeStructure">
        <div class="card">
            <div class="card-body">
                <div id="feeStructureTable">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading fee structure...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collection History Tab -->
    <div class="tab-pane fade" id="collectionHistory">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter"></i> Filter Collections</h5>
            </div>
            <div class="card-body">
                <form id="collectionsFilterForm">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">From Date</label>
                            <input type="date" class="form-control" id="collectionsFromDate" name="from_date">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">To Date</label>
                            <input type="date" class="form-control" id="collectionsToDate" name="to_date">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Payment Method</label>
                            <select class="form-select" id="collectionsMethodFilter" name="payment_method">
                                <option value="">All Methods</option>
                                <option value="CASH">Cash</option>
                                <option value="CARD">Card</option>
                                <option value="BANK_TRANSFER">Bank Transfer</option>
                                <option value="CHEQUE">Cheque</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Filter
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="clearCollectionsFilters">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-body">
                <div id="collectionsTable">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading collections...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fee Type Modal -->
<div class="modal fade" id="feeTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feeTypeModalTitle">Add Fee Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="feeTypeForm">
                <div class="modal-body">
                    <input type="hidden" id="feeTypeId" name="id">
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" id="feeTypeName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category *</label>
                        <select class="form-select" id="feeTypeCategory" name="category" required>
                            <option value="MONTHLY">Monthly Fee</option>
                            <option value="ADMISSION">Admission Fee</option>
                            <option value="EXAM">Exam Fee</option>
                            <option value="FESTIVAL">Festival Fee</option>
                            <option value="SPORTS">Sports Fee</option>
                            <option value="BOOKS">Books Fee</option>
                            <option value="UNIFORM">Uniform Fee</option>
                            <option value="TRANSPORT">Transport Fee</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Charge Trigger *</label>
                        <select class="form-select" id="feeTypeChargeTrigger" name="charge_trigger" required>
                            <option value="MANUAL">Manual Entry Only</option>
                            <option value="ON_ADMISSION">On Student Admission</option>
                            <option value="ON_ENROLLMENT">On Academic Year Enrollment</option>
                            <option value="MONTHLY">Monthly Recurring</option>
                            <option value="ANNUAL">Once Per Year</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="feeTypeDescription" name="description" rows="2"></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="feeTypeIsRecurring" name="is_recurring">
                        <label class="form-check-label" for="feeTypeIsRecurring">Recurring Fee</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Fee Structure Modal -->
<div class="modal fade" id="feeStructureModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feeStructureModalTitle">Add Fee Structure</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="feeStructureForm">
                <div class="modal-body">
                    <input type="hidden" id="feeStructureId" name="id">
                    <div class="mb-3">
                        <label class="form-label">Fee Type *</label>
                        <select class="form-select" id="structureFeeType" name="fee_type" required>
                            <option value="">Select Fee Type</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Branch</label>
                        <select class="form-select" id="structureBranch" name="branch">
                            <option value="">All Branches</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Class</label>
                        <select class="form-select" id="structureClass" name="class_level">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount (QAR) *</label>
                        <input type="number" step="0.01" class="form-control" id="structureAmount" name="amount" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Applicable To *</label>
                        <select class="form-select" id="structureApplicableTo" name="applicable_to" required>
                            <option value="ALL">All Students</option>
                            <option value="PERMANENT">Permanent Only</option>
                            <option value="TEMPORARY">Temporary Only</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Effective From *</label>
                            <input type="date" class="form-control" id="structureEffectiveFrom" name="effective_from" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Effective To *</label>
                            <input type="date" class="form-control" id="structureEffectiveTo" name="effective_to" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Collection Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Fee Receipt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="receiptContent">
                <!-- Receipt content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="Fees.printReceipt()">
                    <i class="fas fa-print"></i> Print Receipt
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/fees.js' %}"></script>
{% endblock %}
